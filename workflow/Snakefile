import pandas as pd

configfile: 'config/chip_seq.yaml'

#TF_EXPERIMENT = {}
#for genome in config['Genome']:
    #print(genome)
    # input/output
    #infile=f'resources/wiggletools mean_v3_{genome}_TFs_only.tab'
    # get tf:experiment dictionary
    #experiment_tf = pd.read_csv(infile,sep='\t',usecols=[0,3],index_col=0)
    #experiment_tf.index = [f'resources/tracks/{genome}/{x}.bw' for x in experiment_tf.index]
#    TF_EXPERIMENT[genome] = experiment_tf.groupby('Antigen').groups
#    for tf in TF_EXPERIMENT[genome]:
        #TF_EXPERIMENT[genome][tf] = list(TF_EXPERIMENT[genome][tf])

def get_chip_table(genome):
    infile=f"resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab"
    experiment_tf = pd.read_csv(infile,sep='\t',usecols=[0,3])
    experiment_tf.columns = ['id','antigen']

    return experiment_tf

def get_experiments_bw(wildcards):
    experiment_tf = get_chip_table(wildcards.genome)
    IDs = list(experiment_tf.loc[experiment_tf.antigen==wildcards.tf,'id'])
    files = [f"resources/tracks/{wildcards.genome}/{id}.bw" for id in IDs]

    return files

def get_experiments_bb(wildcards):
    experiment_tf = get_chip_table(wildcards.genome)
    IDs = list(experiment_tf.loc[experiment_tf.antigen==wildcards.tf,'id'])
    files = [f"resources/tracks/{wildcards.genome}/{id}.05.bb" for id in IDs]

    return files

def get_tfs(genome):
    experiment_tf = get_chip_table(genome)

    return list(experiment_tf.antigen.unique())

def get_tfs_st_exp_gt1(genome):
    experiment_tf = get_chip_table(genome)
    experiment_tf.loc[:,'N'] = [(experiment_tf.antigen==tf).sum() for tf in experiment_tf.antigen]

    return list(experiment_tf.loc[experiment_tf.N>1,:].antigen.unique())

def get_all_svd_files(wildcards):
    TFs = get_tfs(wildcards.genome)
    svd_files = [f"results/{wildcards.genome}/svd/Window_pm{wildcards.window_kb}kb_bin_size_{wildcards.bin_size}/{tf}.hdf5" for tf in TFs]
    return svd_files

def get_tf_mean_wig_promoter(wildcards):
    TFs = get_tfs(wildcards.genome)
    files = [f"results/{wildcards.genome}/TF_mean_chip_prom_pm{wildcards.window_kb}kb/{tf}.wig" for tf in TFs]

    return files

wildcard_constraints:
    window_kb="|".join([str(w) for w in config['Window_kb']]),
    bin_size="|".join([str(b) for b in config['Bin_size']]),
    genome="|".join(config['Genome']),
    tf="|".join(get_tfs('mm10')) + "|" + "|".join(get_tfs('hg38'))

rule all:
    input:
        #
        #expand('results/mm10/TF_mean_chip/{tf}.wig', tf=get_tfs('mm10') ),
        #expand('results/mm10/TF_mean_chip_prom_pm{window_kb}kb/{tf}.wig', window_kb=config['Window_kb'], tf=get_tfs('mm10') ),
        #expand('results/mm10/Summed_TF_chip_prom_pm{window_kb}kb.bw', window_kb=config['Window_kb']),
        #expand('results/hg38/TF_mean_chip/{tf}.wig', tf=get_tfs('hg38') ),
        #expand('results/hg38/TF_mean_chip_prom_pm{window_kb}kb/{tf}.wig', window_kb=config['Window_kb'], tf=get_tfs('hg38') ),
        #expand('results/hg38/Summed_TF_chip_prom_pm{window_kb}kb.bw', window_kb=config['Window_kb']),
        #
        #expand('results/mm10/Chip_tensors/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5', window_kb=config['Window_kb'], bin_size=config['Bin_size'], tf=get_tfs('mm10') ),
        #expand('results/hg38/Chip_tensors/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5', window_kb=config['Window_kb'], bin_size=config['Bin_size'], tf=get_tfs('hg38') ),
        #expand('results/mm10/Peak_tensors/Window_pm{window_kb}kb/{tf}.hdf5', window_kb=config['Window_kb'], tf=get_tfs('mm10') ),
        #expand('results/hg38/Peak_tensors/Window_pm{window_kb}kb/{tf}.hdf5', window_kb=config['Window_kb'], tf=get_tfs('hg38') ),
        #expand('track_hubs/{file}',file=config['Track_hub']['outfiles']),
        expand('results/{genome}/Peak_tensors/Window_pm{window_kb}kb/Sparse_peak_tensor_prom_tf_position.pt', window_kb=config['Window_kb'], genome=config['Genome']),
        #
        #expand('results/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/E2f1.hdf5', window_kb=config['Window_kb'], bin_size=config['Bin_size']),
        #expand('results/fig/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/E2f1.pdf', window_kb=config['Window_kb'], bin_size=config['Bin_size']),
        #
        #expand('results/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5', window_kb=config['Window_kb'], bin_size=config['Bin_size'], tf=get_tfs('mm10')),
        #expand('results/fig/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.pdf', window_kb=config['Window_kb'], bin_size=config['Bin_size'], tf=get_tfs('mm10')),
        #expand('results/fig/hg38/Window_pm{window_kb}kb_bin_size_{bin_size}/svd/{tf}.pdf', window_kb=config['Window_kb'], bin_size=config['Bin_size'], tf=get_tfs_st_exp_gt1('hg38')),
        #
        #expand('results/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/tensor_TF_mode_pos_prom.hdf5', window_kb=config['Window_kb'], bin_size=config['Bin_size']),
        #expand('results/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/tensor_TFsvd1_pos_prom.hdf5', window_kb=config['Window_kb'], bin_size=config['Bin_size']),
        #expand('results/fig/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/mean_chip_signal_per_promoter_per_tf.pdf', window_kb=config['Window_kb'], bin_size=config['Bin_size']),
        #
        #expand('results/{genome}/TF_Complex.tsv',genome=['mm10','hg38'])
        #expand('results/fig/{genome}/mean_chip_signal_per_promoter_per_tf.pdf',genome=['mm10','hg38'])
        #expand('results/mm10/TF_bedfiles/{tf}.bed', tf=get_tfs('mm10') ),
        #expand('results/hg38/TF_bedfiles/{tf}.bed', tf=get_tfs('hg38') ),
        #expand('results/mm10/TF_prom_bedfiles/{tf}.bed', tf=get_tfs('mm10') ),
        #expand('results/hg38/TF_prom_bedfiles/{tf}.bed', tf=get_tfs('hg38') )



# First download data: workflow/Dowload_experiments.smk
# Or rsync between servers
rule chrom_size:
    input:
        chip="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab"
    output:
        chrom_size='resources/{genome}_chrom_size.txt'
    shell:
        """
        python scripts/get_chrom_size.py --chip_experiment {input.chip} --genome {wildcards.genome} --outfile {output.chrom_size}
        """

rule mean_chip_TF:
    input:
        chip="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",
        exp_list=get_experiments_bw
    output:
        mean_wig='results/{genome}/TF_mean_chip/{tf}.wig'
    shell:
        """
        wiggletools mean {input.exp_list} > {output.mean_wig}
        """

rule intersect_mean_chip_TF_with_promoter:
    input:
        wig='results/{genome}/TF_mean_chip/{tf}.wig',
        promoterome="/home/jbreda/Promoterome/results/{genome}/promoterome_pm{window_kb}kb_filtered_clustered_sorted.bed"
    output:
        wig_promoterome='results/{genome}/TF_mean_chip_prom_pm{window_kb}kb/{tf}.wig'
    shell:
        """
        wiggletools overlaps {input.promoterome} {input.wig} > {output.wig_promoterome}
        """

rule sum_TF_chip:
    input:
        tf_wigs_promoterome=get_tf_mean_wig_promoter,
        chrom_size='resources/{genome}_chrom_size.txt'
    output:
        sum_bw='results/{genome}/Summed_TF_chip_prom_pm{window_kb}kb.bw'
    params:
        sum_wig='results/{genome}/Summed_TF_chip_prom_pm{window_kb}kb.wig'
    shell:
        """
        wiggletools sum {input.tf_wigs_promoterome} > {params.sum_wig}
        wigToBigWig {params.sum_wig} {input.chrom_size} {output.sum_bw}
        """

# TODO: peak calling on summed bw in promoterome
#rule call_peaks:
#    input:
#        sum_bw='results/{genome}/Summed_TF_chip_prom_pm{window_kb}kb.bw'
#        promoterome="/home/jbreda/Promoterome/results/{genome}/promoterome_pm{window_kb}kb_filtered.bed"
#    output:
#        peaks='results/{genome}/Summed_TF_chip_prom_pm{window_kb}kb_peaks.bed
#    shell:
#        """
#        python scripts/call_peaks.py --infile_sum_bw {input.sum_bw} --infile_promoterome {input.promoterome} --outfile {output.peaks}
#        """


rule make_chip_tensors:
    input:
        infile="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",# Dependence: used in get_experiments_bw
        exp_list=get_experiments_bw
    output:
        tensor='results/{genome}/Chip_tensors/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5'
    threads: 20
    shell:
        """
        python scripts/make_chip_promoter_experiment_tensors.py --threads {threads} --tf {wildcards.tf} --genome {wildcards.genome} --window_kb {wildcards.window_kb} --bin_size {wildcards.bin_size} --outfile {output.tensor} --infiles_tf {input.exp_list}
        """

rule make_peak_tensors:
    input:
        infile="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",# Dependence: used in get_experiments_bb
        exp_list=get_experiments_bb
    output:
        tensor='results/{genome}/Peak_tensors/Window_pm{window_kb}kb/{tf}.hdf5'
    shell:
        """
        python scripts/make_peak_promoter_experiment_tensors.py --tf {wildcards.tf} --genome {wildcards.genome} --window_kb {wildcards.window_kb} --outfile {output.tensor} --infiles_tf {input.exp_list}
        """

rule make_peak_table:
    input:
        infile="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",
    output:
        table="results/{genome}/peak_table_pm{window_kb}kb.txt"
    params:
        promoterome="/home/jbreda/Promoterome/results/{genome}/promoterome_pm{window_kb}kb_filtered.bed"
    shell:
        """
        python scripts/make_peak_tables.py --genome {wildcards.genome} --promoterome {params.promoterome} --out_file {output.table}
        """

rule make_peak_prom_tf_pos_sparse_tensor:
    input:
        chip_experiment_table="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",
        promoterome="/home/jbreda/Promoterome/results/{genome}/promoterome_pm{window_kb}kb_filtered_clustered_sorted.bed"
    output:
        tensor='results/{genome}/Peak_tensors/Window_pm{window_kb}kb/Sparse_peak_tensor_prom_tf_position.pt'
    threads: 72
    shell:
        """
        python scripts/make_peak_prom_tf_pos_tensor.py --chip_experiment_table {input.chip_experiment_table} \
                                                       --infile_promoterome {input.promoterome} \
                                                       --outfile {output.tensor} \
                                                       --window_kb {wildcards.window_kb} \
                                                       --threads {threads}
        """

rule svd:
    input:
        chip='results/{genome}/Chip_tensors/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5',
        peak='results/{genome}/Peak_tensors/Window_pm{window_kb}kb/{tf}.hdf5'
    output:
        svd='results/{genome}/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5'
    threads: 12
    shell:
        """
        python scripts/get_Chip_svd.py --infile_chip {input.chip} --infile_peak {input.peak} --outfile {output.svd} --window_kb {wildcards.window_kb} --bin_size {wildcards.bin_size}
        """

rule plot_svd:
    input:
        svd='results/{genome}/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.hdf5'
    output:
        fig='results/fig/{genome}/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/{tf}.pdf'
    shell:
        """
        python scripts/plot_svd_per_tf.py --infile {input.svd} --outfig {output.fig} 
        """

rule make_track_hubs:
    input:
        chip=expand("resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",genome=['mm10','hg38']),
        mm10=expand('results/mm10/svd/{tf}.hdf5', tf=get_tfs('mm10') ),
        hg38=expand('results/hg38/svd/{tf}.hdf5', tf=get_tfs('hg38') )
    output:
        expand('track_hubs/{file}',file=config['Track_hub']['outfiles']),
    shell:
        """
        python scripts/make_track_hubs.py
        """

# rule Chip 1st comp. matrix:
# TODO: make plot in a separate rule
rule get_chip_1st_comp:
    input:
        svd_files=get_all_svd_files, # all svd files for dependence
        promoterome="/home/jbreda/Promoterome/results/{genome}/promoterome_pm{window_kb}kb_filtered.bed"
    output:
        tensor_tf_pos_prom='results/{genome}/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/tensor_TFsvd1_pos_prom.hdf5',
        #fig='results/fig/{genome}/mean_chip_signal_per_promoter_per_tf.pdf'
    threads: 1
    shell:
        """
        python scripts/get_chip_1st_svd_matrix_plot_signal_distribution.py --infile_promoterome {input.promoterome} \
                                                                           --infiles_svd {input.svd_files} \
                                                                           --outfile_tf_pos_prom {output.tensor_tf_pos_prom} \
                                                                           --genome {wildcards.genome} \
                                                                           --window_kb {wildcards.window_kb} \
                                                                           --threads {threads}
        """

rule plot_chip_1st_comp:
    input:
        infile_chip="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",
        tensor_tf_pos_prom='results/{genome}/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/tensor_TFsvd1_pos_prom.hdf5',
    output:
        fig='results/fig/{genome}/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/mean_chip_signal_per_promoter_per_tf.pdf'
    shell:
        """
        python scripts/plot_average_profile_per_TF.py --infile_chip {input.infile_chip} --infile_tf_pos_prom {input.tensor_tf_pos_prom} --outfig {output.fig} --genome {wildcards.genome} --window_kb {wildcards.window_kb} --bin_size {wildcards.bin_size}
        """

rule get_chip_tf_mode_pos_prom:
    input:
        svd_files=get_all_svd_files, # all svd files for dependence
        chip="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab",
        promoterome="/home/jbreda/Promoterome/results/{genome}/promoterome_pm{window_kb}kb_filtered.bed"
    output:
        tensor_tf_pos_prom='results/mm10/svd/Window_pm{window_kb}kb_bin_size_{bin_size}/tensor_TF_mode_pos_prom.hdf5',
    threads: 12
    shell:
        """
        python scripts/get_chip_svd_matrix.py --infile_chip {input.chip} \
                                              --infile_promoterome {input.promoterome} \
                                              --outfile_tf_pos_prom {output.tensor_tf_pos_prom} \
                                              --infiles_svd {input.svd} \
                                              --genome {wildcards.genome} \
                                              --window_kb {wildcards.window_kb}
        """

# run this rule only after downloading data with ./download_complex_data.sh
rule get_tf_complex:
    input:
        chip="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab"
    output:
        results="results/{genome}/TF_Complex.tsv"
    params:
        complexes = lambda wildcards: config['TF_Complex'][wildcards.genome]
    shell:
        """
        python scripts/get_complex_proteins.py  --infile_complex {params.complexes} --infile_chip {input.chip} --outfile {output.results}
        """
        
# rule multivariate_gaussian:
#   Multivariate_gaussian_gene_factor.py


# Chip peaks rules:
rule merge_peaks_per_tf:
    input:
        infile="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab"
    output:
        bedfile='results/{genome}/TF_bedfiles/{tf}.bed'
    threads: 4
    shell:
        """
        scripts/merge_tf_bigbeds.sh {wildcards.genome} {wildcards.tf} {input.infile} {output.bedfile}
        """

rule intersect_peaks_with_promoterome:
    input:
        bedfile='results/{genome}/TF_bedfiles/{tf}.bed',
        promoterome="/home/jbreda/Promoterome/results/{{genome}}/promoterome_pm{win}kb_filtered.bed".format(win = config['Window_kb'])
    output:
        bedfile='results/{genome}/TF_prom_bedfiles/{tf}.bed'
    shell:
        """
        bedtools intersect -a {input.bedfile} -b <(tail -n+2 {input.promoterome}) | bedtools sort | uniq > {output.bedfile}
        """

rule get_nr_of_peaks_per_prom:
    input:
        promoterome="/home/jbreda/Promoterome/results/{{genome}}/promoterome_pm{win}kb_filtered.bed".format(win = config['Window_kb']),
        chip="resources/experimentList_v3_{genome}_TFs_only_QC_filtered.tab"
    output:
        file='results/{genome}/nr_peaks_per_prom_per_tf.tsv'
    shell:
        """
        scripts/get_nr_of_peaks_per_prom_per_tf.sh {input.promoterome} {input.chip} {output.file}
        """